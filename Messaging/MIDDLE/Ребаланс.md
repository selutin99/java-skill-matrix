# Взаимосвязь количества продюсеров, консьюмеров и партиций. Знает что такое ребаланс, когда вызывается и что при этом происходит

## 1. Взаимосвязь продюсеров, консюмеров и партиций

### **Producers ↔ Partitions**

* Каждый продюсер может писать в **любой топик и любую партицию**.
* Kafka сама распределяет сообщения по партициям:

    * **по ключу** (всегда в одну партицию → сохраняется порядок для ключа),
    * **без ключа** (round-robin).
* Количество продюсеров никак жёстко не ограничено числом партиций.

---

### **Consumers ↔ Partitions**

* Чтение работает через **consumer group**:

    * В группе каждый консюмер получает **свою часть партиций**.
    * **Одна партиция может принадлежать только одному консюмеру в группе.**
* Важные правила:

    * Если **консюмеров > партиций**, “лишние” консюмеры будут простаивать.
    * Если **консюмеров < партиций**, один консюмер может читать несколько партиций.
    * Оптимально, когда число партиций ≥ число консюмеров в группе.

---

### **Producers ↔ Consumers**

* Прямая зависимость отсутствует.
* Продюсеры пишут в топик, консюмеры читают из него независимо.
* Но для гарантирования порядка сообщений важно:

    * Один ключ = одна партиция.
    * Один консюмер в группе читает всю партицию последовательно.

---

## 2. Что такое ребаланс (rebalance)

**Rebalance** — это процесс перераспределения партиций между консюмерами внутри одной consumer group.

### Когда вызывается

1. В группу добавляется новый консюмер.
2. Консюмер уходит (умирает или выключается).
3. Консюмер “подвисает” и не посылает heartbeat (сессия истекла по `session.timeout.ms`).
4. Меняется число партиций в топике.

---

### Что при этом происходит

1. **Координатор группы (Group Coordinator)** инициирует ребаланс.
2. Всем консюмерам говорят **“остановите чтение”**.
3. Партиции перераспределяются между консюмерами:

    * Может использоваться **RangeAssignor, RoundRobinAssignor, StickyAssignor** и др. (алгоритмы распределения).
4. Консюмеры начинают читать “свои” новые партиции.

---

### Последствия ребаланса

* **Плюсы**: партиции равномерно распределены → баланс нагрузки.
* **Минусы**: во время ребаланса **останавливается чтение** → задержка в обработке.
* В больших системах слишком частые ребалансы → серьёзная проблема.
* Чтобы минимизировать:

    * Увеличивают `session.timeout.ms` и `max.poll.interval.ms`.
    * Используют **static membership** (Kafka 2.3+) → чтобы при рестарте консюмер “сохранил” свои партиции.

---

## 3. Выжимка для собеседования

* Продюсеры могут писать в любые партиции, их число не ограничено. 
Несколько продюсеров могут писать в одну и ту же партицию.
Итоговый порядок сообщений внутри партиции сохраняется, но между продюсерами никакой глобальной синхронизации нет.
* В одной consumer group каждая партиция читается только одним консюмером.
* Количество консюмеров ≤ количество партиций (иначе будут простаивающие).
* **Rebalance** — это перераспределение партиций между консюмерами.

    * Вызывается при изменении числа консюмеров или партиций, либо при сбое.
    * В процессе чтение останавливается, после чего партиции перераспределяются.
* Чтобы уменьшить проблемы от ребаланса, используют **sticky assignor** и **static membership**.
