# Какие гарантии порядка предоставляет Kafka

## 1. **Внутри партиции**

* Сообщения в каждой партиции хранятся в виде **append-only лога**.
* Порядок **строго сохраняется**:

    * Сообщение, записанное позже, всегда получит больший offset.
    * Консюмер читает их именно в этом порядке.
* ✅ Kafka гарантирует: *“сообщения читаются консюмерами в том порядке, в котором они записаны в партицию”*.

---

## 2. **Между партициями одного топика**

* **Глобального порядка нет.**
* Если топик состоит из нескольких партиций, то:

    * Сообщения в разных партициях могут приходить консюмерам в разном порядке.
    * Kafka **не синхронизирует порядок между партициями**.
* ❌ Если порядок “всех сообщений” важен → нужно ограничиться **одной партицией**.

---

## 3. **По ключу сообщения**

* Если продюсер указывает **ключ (key)**, Kafka гарантирует, что:

    * Все сообщения с этим ключом попадут в одну и ту же партицию.
    * Соответственно, **порядок сообщений для одного ключа всегда сохраняется**.
* Пример: все события пользователя с `userId=123` будут упорядочены, даже если топик имеет десятки партиций.

---

## 4. **При нескольких продюсерах**

* Если **несколько продюсеров пишут в одну партицию**, Kafka сохраняет порядок **по времени приёма брокером**, а не по времени отправки.
* То есть порядок межпродюсерских событий может “перемешаться”, но внутри партиции Kafka будет его фиксировать.

---

## 5. **С транзакциями (Exactly-once)**

* Если использовать транзакционный продюсер, Kafka гарантирует, что **все записи транзакции попадут в лог атомарно** и консюмер увидит их строго в том порядке, в котором они были зафиксированы.

---

## 6. Выжимка для собеседования

* **Kafka гарантирует порядок только внутри партиции.**
* **Между партициями порядок не гарантируется.**
* **По ключу сообщений** порядок сохраняется (все события с одинаковым ключом попадают в одну партицию).
* **Несколько продюсеров** могут писать в одну партицию, порядок определяется временем записи брокером.
* **Глобальный порядок по топику возможен только при одной партиции.**
