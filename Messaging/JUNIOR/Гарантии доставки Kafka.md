# Гарантии доставки Kafka, как это настраивается

Kafka может обеспечить три уровня доставки сообщений от **Producer → Broker → Consumer**.

## 1. **At most once** ("не больше одного раза")

* Сообщение может потеряться, но **никогда не будет доставлено дважды**.
* Происходит, если продюсер не ждёт подтверждения (`acks=0`), или консумер читает, но не успевает закоммитить offset перед падением.
* ✅ Быстро, но небезопасно.
* ❌ Потеря сообщений возможна.

---

## 2. **At least once** ("не меньше одного раза")

* Сообщение **будет доставлено**, но может быть прочитано **несколько раз** (дубликаты).
* Дубликаты появляются, если:

    * продюсер повторно отправляет сообщение из-за сетевого сбоя,
    * консумер зафиксировал offset позже, чем обработал сообщение.
* ✅ Сообщения не теряются.
* ❌ Возможны дубликаты, их нужно обрабатывать в приложении (идемпотентность).

---

## 3. **Exactly once** ("ровно один раз")

* Сообщение доставляется **гарантированно и без дубликатов**.
* Реализуется комбинацией:

    * **Idempotent Producer** (`enable.idempotence=true`) → предотвращает повторную запись одного и того же сообщения при ретраях.
    * **Transactional Producer** (транзакции в Kafka) → запись сообщений + фиксация offset консумера в рамках одной транзакции.
    * Консумер читает с использованием **read-process-write** паттерна с транзакциями.
* ✅ Самая сильная гарантия.
* ❌ Более высокая задержка и сложнее настройка.

---

## 4. Как настраивается

### На стороне **Producer**

* `acks`

    * `0` → не ждать подтверждения (at most once).
    * `1` → ждать подтверждения только от лидера (at least once).
    * `all` → ждать подтверждения от всех реплик (at least once, с минимальным риском потерь).
* `enable.idempotence=true` → включить идемпотентность (нужна для exactly once).
* `retries` → количество повторных попыток записи.

---

### На стороне **Consumer**

* `enable.auto.commit` (по умолчанию true)

    * Если true → оффсеты коммитятся автоматически (могут быть дубликаты).
    * Если false → приложение вручную контролирует коммиты, обычно после успешной обработки сообщения.
* При использовании транзакций продюсера можно коммитить **оффсеты консумера вместе с записью** (`sendOffsetsToTransaction`).

---

### На стороне **Broker**

* `min.insync.replicas` → сколько реплик должны подтвердить запись для успеха (вместе с `acks=all` даёт гарантии без потерь).

---

## 5. Выжимка для собеседования

* Kafka поддерживает **три уровня доставки**:

    * **At most once** → быстро, но можно потерять сообщение.
    * **At least once** → надёжно, но возможны дубликаты.
    * **Exactly once** → надёжно и без дубликатов (idempotence + транзакции).
* Управляется параметрами:

    * **Producer**: `acks`, `enable.idempotence`, `retries`.
    * **Consumer**: `enable.auto.commit`, транзакционные оффсеты.
    * **Broker**: `min.insync.replicas`.
