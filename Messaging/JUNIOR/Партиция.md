# Что такое партиция, на что влияет, как происходит запись сообщения

## 1. Партиция (Partition) в Kafka

### Что это такое

* **Партиция** — это физическое деление топика.
* Каждый топик может состоять из **одной или нескольких партиций**.
* Сообщения в каждой партиции:

    * **имеют строгий порядок** (append-only лог).
    * Имеют **смещение (offset)** — уникальный номер внутри партиции.

---

### Зачем нужны партиции

1. **Масштабирование (throughput)**

    * Несколько продюсеров могут писать в разные партиции параллельно.
    * Несколько консумеров в одной группе читают данные из разных партиций.

2. **Производительность**

    * Увеличение числа партиций позволяет обрабатывать больше сообщений одновременно.

3. **Отказоустойчивость**

    * Каждая партиция может иметь реплики на разных брокерах.
    * Один брокер хранит **лидера партиции**, остальные — **фолловеров** (реплики).

---

## 2. Как происходит запись сообщения

1. **Producer выбирает партицию**:

    * По **ключу сообщения (key)** — Kafka применяет хэш-функцию от key → определяет партицию.

        * Все сообщения с одинаковым ключом всегда попадают в одну партицию → **сохраняется порядок для ключа**.
    * Если ключа **нет**, Kafka распределяет записи по партициям **равномерно** (round-robin).

2. **Producer отправляет сообщение в брокер-лидер партиции**:

    * Брокер принимает запись и сохраняет её в лог-файл.
    * Каждое сообщение получает **offset** — уникальный номер в этой партиции.

3. **Репликация**:

    * Лидер партиции рассылает данные фолловерам.
    * Продюсер может настроить уровень подтверждения (`acks`):

        * `acks=0` → не ждать подтверждения.
        * `acks=1` → ждать подтверждения от лидера.
        * `acks=all` → ждать подтверждения от всех реплик.

---

## 3. Влияние числа партиций

* **Порядок сообщений**: гарантирован только внутри одной партиции, глобального порядка по топику нет.
* **Пропускная способность**: больше партиций → выше параллелизм → выше throughput.
* **Чтение консумерами**: в одной consumer group **каждую партицию читает только один консумер**.
* **Балансировка**: если консумеров меньше, чем партиций, некоторые консумеры будут читать несколько партиций.

---

## 4. Выжимка для собеседования

* **Партиция** — это упорядоченный лог сообщений внутри топика.
* Она влияет на **масштабирование, порядок и производительность**.
* Запись происходит так: **продюсер → выбор партиции → брокер-лидер → offset → репликация**.
* **Порядок сохраняется только внутри партиции**, но не между партициями.
