# Как устроен механизм транзакций в Kafka

## 1. Зачем Kafka нужны транзакции

Kafka изначально обеспечивала только **at-least-once** семантику (надёжно, но с дубликатами).
Чтобы реализовать **exactly-once** (ровно один раз), понадобились:

1. **Идемпотентный продюсер** — предотвращает дубликаты при ретраях.
2. **Транзакции** — позволяют:

    * атомарно записывать **несколько сообщений** в один или несколько топиков,
    * одновременно коммитить оффсеты консюмера (**read-process-write** паттерн).

---

## 2. Как работает транзакционный продюсер

1. **Инициализация**

    * Продюсер получает **transactional.id** — уникальный идентификатор транзакции.
    * На его основе Kafka создаёт **PID (Producer ID)**.
    * Если продюсер перезапустился с тем же `transactional.id`, Kafka понимает, что это продолжение работы.

2. **Начало транзакции**

    * Вызывается `initTransactions()` и затем `beginTransaction()`.
    * Все последующие записи считаются частью транзакции.

3. **Отправка сообщений**

    * Продюсер пишет сообщения в топики.
    * Брокеры их сохраняют как *"pending records"* (не видны консюмерам).

4. **Работа с оффсетами**

    * Если продюсер реализует паттерн **consume-transform-produce**, он может вызвать `sendOffsetsToTransaction()` → оффсеты консюмера фиксируются вместе с сообщениями.
    * Это решает проблему: *“сообщение обработано, но оффсет ещё не закоммичен”*.

5. **Фиксация транзакции**

    * `commitTransaction()` → все сообщения + оффсеты становятся видимыми атомарно.
    * Если что-то пошло не так → `abortTransaction()`, и записи помечаются как “абортированные”, консюмеры их не увидят.

---

## 3. Роль Transaction Coordinator

* В кластере есть специальный компонент — **Transaction Coordinator** (работает на брокере).
* Его задачи:

    * назначить продюсеру **PID** и вести его состояние,
    * следить за жизненным циклом транзакций,
    * хранить метаданные в специальном **топике `__transaction_state`**,
    * гарантировать атомарность “commit/abort” даже в случае сбоев.

---

## 4. Ограничения и нюансы

* Транзакции работают только для **idempotent producer** (`enable.idempotence=true`).
* Нужно задать `transactional.id` (без него транзакций не будет).
* Немного больше задержки (latency), так как добавляется координация.
* Использовать имеет смысл, если важна **exactly-once семантика** (финансовые транзакции, логика с деньгами, биллинг).

---

## 5. Выжимка для собеседования

* **Транзакции в Kafka нужны для exactly-once семантики.**
* Продюсер с `transactional.id` работает с **Transaction Coordinator**.
* Механизм:

    * `beginTransaction()` → отправка сообщений → (опционально) `sendOffsetsToTransaction()` → `commitTransaction()` или `abortTransaction()`.
* Все записи в рамках транзакции становятся видимыми **атомарно**.
* Транзакции позволяют объединить в одну операцию: *обработку сообщений консюмера + запись новых сообщений*.
* Минус: больше задержка, сложнее настройка, нагрузка на координатор.
