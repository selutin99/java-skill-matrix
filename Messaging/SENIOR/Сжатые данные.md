# Как Kafka работает со сжатыми данными

## 1. Зачем нужно сжатие в Kafka

* Kafka может обрабатывать **миллионы сообщений в секунду**, и сжатие помогает:

    * уменьшить нагрузку на сеть,
    * снизить потребление диска,
    * уменьшить задержки при пересылке.

---

## 2. Где происходит сжатие

1. **Producer**

    * Продюсер может сжимать **batch сообщений** (не каждое сообщение по отдельности, а сразу пачку).
    * Kafka поддерживает алгоритмы:

        * `gzip` (хорошее сжатие, но медленное),
        * `snappy` (быстрое, среднее сжатие),
        * `lz4` (баланс скорость/размер),
        * `zstd` (новый, лучший компромисс).
    * Настройка: `compression.type` в конфигурации продюсера.

2. **Broker**

    * Брокер получает сжатый batch и сохраняет его на диск **в сжатом виде** (zero-copy).
    * Брокер **не распаковывает** данные при хранении и пересылке, он их передаёт как есть.

3. **Consumer**

    * Консюмер получает тот же сжатый batch.
    * **Декомпрессия происходит на стороне консюмера**, когда он реально читает сообщения.

---

## 3. Важные особенности

* **Сжатие происходит на уровне batch**, а не отдельных сообщений → это экономичнее.
* Брокер **может перепаковать batch** в другой формат сжатия, если у него установлен `compression.type`. Например:

    * Продюсер → пишет `gzip`,
    * Брокер → хранит `lz4`,
    * Консюмер → читает `lz4`.
* Но чаще брокер хранит данные именно в том виде, как их прислал продюсер.

---

## 4. Преимущества

* Сильно снижает сетевой трафик между продюсером ↔ брокером ↔ консюмером.
* Уменьшает нагрузку на диск (Kafka хранит меньше данных).

---

## 5. Минусы

* Дополнительная нагрузка на CPU (особенно у консюмеров, которые должны разжимать данные).
* Выбор алгоритма → компромисс между скоростью и степенью сжатия.

---

## 6. Выжимка для собеседования

* Kafka поддерживает **сжатие сообщений на уровне batch**.
* Настраивается параметром `compression.type` (`gzip`, `snappy`, `lz4`, `zstd`).
* **Продюсер** сжимает данные, **брокер** хранит и пересылает в сжатом виде, **консюмер** разжимает при чтении.
* Сжатие снижает нагрузку на сеть и диск, но увеличивает нагрузку на CPU.
* Брокер может “пересжать” данные в другой формат, но обычно хранит как есть.
