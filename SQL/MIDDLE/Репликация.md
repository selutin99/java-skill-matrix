# Как обеспечивается сохранность данных, что такое репликация, как происходит запись\чтение

## 1. Как обеспечивается сохранность данных

1. **Журнал транзакций (Write-Ahead Log, WAL / redo log)**

    * Перед изменением данных в таблице, запись сначала сохраняется в журнал (лог).
    * Если произошёл сбой — СУБД может восстановить состояние, «прокрутив» журнал.
    * Это основа принципа **Durability** из ACID.

2. **Механизм транзакций**

    * Если транзакция не завершилась (`COMMIT`), её изменения откатываются.
    * Если завершилась — гарантируется запись в лог и на диск.

3. **Чекпоинты (Checkpoints)**

    * Периодически СУБД сбрасывает изменённые страницы из памяти (буфера) на диск.
    * Это ускоряет восстановление после сбоя, так как не нужно проигрывать весь журнал.

4. **Бэкапы**

    * Полные (полная копия БД).
    * Инкрементальные (сохраняются только изменения).
    * Point-in-time recovery (восстановление на определённый момент).

---

## 2. Репликация

**Репликация** — это копирование данных с одной базы (master/primary) на другие узлы (replica/standby), чтобы:

* повысить отказоустойчивость,
* масштабировать чтение,
* иметь горячий резерв.

### Виды репликации:

1. **Синхронная**

    * Запись считается завершённой только после того, как данные записаны и на master, и на replica.
    * Обеспечивает сильную консистентность, но может замедлять транзакции.

2. **Асинхронная**

    * Master отвечает клиенту сразу после своей записи, а replica получает данные чуть позже.
    * Быстрее, но возможна потеря последних изменений при сбое master.

3. **Полурепликация (semi-sync)**

    * Master ждёт хотя бы одного подтверждения от replica, но не всех.

---

## 3. Как происходит запись и чтение

### Запись:

1. Клиент выполняет `INSERT/UPDATE/DELETE`.
2. СУБД записывает изменения в **журнал транзакций (WAL)**.
3. Подтверждает `COMMIT` → клиент получает ответ.
4. Фоновые процессы СУБД сбрасывают изменения в сами таблицы (data files).
5. (Если включена репликация) — журнал пересылается на реплики, и они применяют изменения.

### Чтение:

1. Клиент делает `SELECT`.
2. СУБД проверяет буфер в памяти (shared buffer/cache).
3. Если данных нет в памяти — читает с диска.
4. Если используется репликация — можно читать с replica (для разгрузки master).

---

## 4. Выжимка для собеседования

* Сохранность данных обеспечивается: журналами транзакций (WAL), чекпоинтами, транзакциями (ACID), бэкапами.
* Репликация = копирование данных на реплики.

    * **Синхронная** — данные не теряются, но медленнее.
    * **Асинхронная** — быстрее, но риск потери последних записей.
* Запись = сначала в лог, потом в таблицу, плюс рассылка на реплики.
* Чтение = сначала из кэша, потом с диска; возможно с реплик.
