# Что такое мониторинг и observability, что такое prometheus и grafana, как настроить мониторинг для своего приложения

## 1. Мониторинг и Observability

### 1.1. Мониторинг

* **Мониторинг** — это сбор и отображение заранее определённых метрик.
* Отвечает на вопрос: *«Что сломалось?»*
* Примеры: CPU > 90%, сервис недоступен, HTTP 500 растут.

### 1.2. Observability (наблюдаемость)

* Более широкое понятие: способность системы «объяснить» своё поведение через сигналы.
* Три столпа:

    1. **Metrics** — числовые показатели (RPS, latency, CPU).
    2. **Logs** — текстовые события (ошибки, бизнес-логи).
    3. **Traces** — распределённые трассировки запросов (end-to-end).
* Отвечает на вопрос: *«Почему сломалось?»*

---

## 2. Prometheus и Grafana

### 2.1. Prometheus

* Система мониторинга (Cloud Native стандарт).
* Работает по модели **pull**: сам ходит за метриками по HTTP (`/metrics`).
* Метрики в формате **time series** (временные ряды).
* Использует язык запросов **PromQL**.
* Подходит для: инфраструктуры, приложений, бизнес-метрик.

**Пример метрики (Spring Boot Actuator + Micrometer):**

```
http_server_requests_seconds_count{method="GET",status="200",uri="/api/app"} 1023
http_server_requests_seconds_sum{...} 12.34
```

### 2.2. Grafana

* UI для визуализации данных.
* Подключается к Prometheus (и другим источникам).
* Делает **дашборды, графики, алерты**.

---

## 3. Настройка мониторинга приложения

### 3.1. Подключение метрик в приложении (Spring Boot + Micrometer)

```xml
<!-- pom.xml -->
<dependency>
  <groupId>io.micrometer</groupId>
  <artifactId>micrometer-registry-prometheus</artifactId>
</dependency>
```

**application.yaml**

```yaml
management:
  endpoints:
    web:
      exposure:
        include: prometheus,health,info
  endpoint:
    prometheus:
      enabled: true
```

После запуска:

```
http://localhost:8080/actuator/prometheus
```

---

### 3.2. Prometheus конфиг (prometheus.yml)

```yaml
global:
  scrape_interval: 15s
scrape_configs:
  - job_name: 'myapp'
    metrics_path: '/actuator/prometheus'
    static_configs:
      - targets: ['myapp:8080']
```

---

### 3.3. docker-compose (Prometheus + Grafana)

```yaml
version: "3.9"
services:
  prometheus:
    image: prom/prometheus:v2.54.0
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"

  grafana:
    image: grafana/grafana:11.0.0
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
```

Открыть:

* Prometheus → [http://localhost:9090](http://localhost:9090)
* Grafana → [http://localhost:3000](http://localhost:3000) (логин admin/admin)

---

### 3.4. Настройка алертов (пример)

```yaml
groups:
  - name: myapp.rules
    rules:
      - alert: HighErrorRate
        expr: rate(http_server_requests_seconds_count{status=~"5.."}[5m]) > 1
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "High 5xx error rate"
          description: "App {{ $labels.app }} returns 5xx more than 1 rps"
```

---

### 3.5. Визуализация в Grafana

* Подключить Prometheus как **Data Source**.
* Импортировать готовый дашборд (например, `Spring Boot Micrometer` из каталога grafana.com/dashboards).
* Настроить алерты → Email, Slack, Telegram.

---

## 4. Best Practices

* Собирать **технические метрики** (CPU, память, GC) и **бизнес-метрики** (число заказов, время ответа API).
* Держать **Retetion Policy** (например, 15–30 дней в Prometheus).
* Для долгосрочного хранения → Thanos, VictoriaMetrics, Cortex.
* Логи и трейсы — отдавать в ELK/EFK и Jaeger/Tempo.
* Алерты делать actionable: чтобы по ним было понятно, что делать.

---

## 5. Выжимка для собеседования

* **Мониторинг**: сбор заранее заданных метрик («что сломалось»).
* **Observability**: метрики + логи + трейсы, позволяет понять «почему сломалось».
* **Prometheus**: time-series база + pull-модель, язык PromQL, интеграция с Micrometer, kube-state-metrics, node\_exporter.
* **Grafana**: визуализация, дашборды, алерты.
* **Настройка мониторинга для приложения**:

    * Экспорт метрик (`/metrics` или `/actuator/prometheus`).
    * Prometheus собирает их.
    * Grafana визуализирует.
    * Алертинг по ключевым SLA/SLO метрикам.
