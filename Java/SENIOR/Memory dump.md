# Что такое memory dump, для чего он используется и как им пользоваться

## 1️⃣ Что такое **Memory Dump**

Memory dump (дамп памяти) — это **снимок всей памяти JVM в конкретный момент времени**. Он фиксирует все объекты, которые находятся в куче, ссылки между ними и состояние потоков.
По сути, это «фотография» того, что находится в памяти приложения прямо сейчас.

---

## 2️⃣ Для чего используется

1. **Диагностика утечек памяти (memory leaks)**

    * Если объекты остаются в памяти дольше, чем нужно, дамп покажет, **кто их удерживает**.

2. **Анализ OutOfMemoryError**

    * После ошибки можно посмотреть, **какие объекты занимали память** и в каком объёме.

3. **Понимание структуры объекта**

    * Полезно для оптимизации больших структур данных, чтобы уменьшить потребление памяти.

4. **Отладка сложных проблем в продакшене**

    * Иногда проще сделать дамп памяти, чем воспроизводить проблему локально.

---

## 3️⃣ Как пользоваться

### Шаг 1: Сделать дамп

1. Через JVM-инструменты:

```bash
# Через jmap (JDK)
jmap -dump:format=b,file=heapdump.hprof <pid>
```

* `<pid>` — идентификатор процесса Java.
* `heapdump.hprof` — файл дампа памяти.

2. Через профайлеры:

    * **VisualVM**, **YourKit**, **JProfiler** — есть кнопка «Take heap dump».

3. В продакшене можно использовать **-XX:+HeapDumpOnOutOfMemoryError**:

```bash
java -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/tmp/heapdump.hprof -jar app.jar
```

* JVM автоматически создаст дамп при OOM.

---

### Шаг 2: Анализировать дамп

* **Eclipse Memory Analyzer (MAT)** — бесплатный мощный инструмент.
* **VisualVM** — встроенный инструмент JDK.
* **YourKit / JProfiler** — профессиональные коммерческие профайлеры.

**Что ищут при анализе:**

* Большие объёмы памяти по типам объектов.
* Объекты, удерживаемые корнями (GC roots).
* Цепочки ссылок, которые мешают сборке мусора.
* «Подозрительные» структуры (например, Map или List, которые растут бесконтрольно).

---

## 4️⃣ Рекомендации

* Дамп может быть очень большим (гигабайты), будьте готовы к дисковому пространству.
* Анализ лучше делать на копии файла, а не в продакшене напрямую.
* Часто делают **несколько дампов с интервалом**, чтобы увидеть динамику: какие объекты появляются и не уходят.
