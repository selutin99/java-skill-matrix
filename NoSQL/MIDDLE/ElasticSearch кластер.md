# Как устроен кластер ElasticSearch и как хранятся данные

## 1. Устройство кластера ElasticSearch

1. **Кластер**

    * Набор узлов (**nodes**), объединённых в единый логический ElasticSearch-кластер.
    * Идентифицируется **именем кластера**.
    * Пользователь обращается к кластеру как к единой системе.

2. **Узел (node)**

    * Отдельный инстанс ElasticSearch (обычно — процесс JVM).
    * Может выполнять разные роли:

        * **Master node** — управляет метаданными: индексы, шарды, распределение.
        * **Data node** — хранит и обрабатывает данные (индексы, поиск, агрегации).
        * **Ingest node** — предобработка документов (pipeline).
        * **Coordinating node** — «фронт», принимает запросы, распределяет их между data node.
        * (В последних версиях роли разделяются более явно: hot/warm/cold/frozen data nodes).

3. **Индекс (index)**

    * Логическая сущность, аналог таблицы в реляционных БД.
    * Содержит документы.
    * Индекс разбивается на **шарды**.

4. **Шард (shard)**

    * Основная единица хранения и поиска.
    * Физически — это Lucene-индекс.
    * Бывает:

        * **Primary shard** (основной).
        * **Replica shard** (копия для отказоустойчивости и балансировки запросов).
    * Количество primary-шардов задаётся при создании индекса.

5. **Репликация**

    * Каждый primary shard имеет 0..N реплик.
    * Реплики хранятся на разных узлах (failover).
    * Запросы на чтение могут идти в реплики, что повышает производительность.

---

## 2. Как хранятся данные

1. **Документ**

    * Основная единица данных (JSON-объект).
    * Содержится в индексе.
    * У каждого документа есть:

        * `_id` — уникальный идентификатор.
        * `_source` — исходный JSON.
        * Инвертированные индексы для поиска по полям.

2. **Хранение и индексация**

    * Документ при записи проходит через анализаторы (анализ текста, токенизация).
    * Поля могут храниться в разных видах:

        * `text` — полнотекстовый анализ.
        * `keyword` — точные значения (агрегации, сортировка).
    * После обработки документ сохраняется в **primary shard**, а затем реплицируется.

3. **Механизм распределения**

    * Elastic сам решает, в какой шард поместить документ (по хэшу `_id`).
    * Дальше данные распределяются по нодам.

4. **Поиск и агрегации**

    * Запрос → coordinating node → все шарды индекса.
    * Каждый шард обрабатывает запрос локально (Lucene).
    * Результаты собираются и объединяются на coordinating node.

---

## 3. Выжимка для собеседования

* Кластер ElasticSearch = **набор узлов** (master, data, ingest, coordinating).
* Данные хранятся в **индексах**, которые разбиваются на **шарды** (primary + replica).
* **Документ** — JSON, индексируется Lucene (инвертированные индексы для поиска).
* **Запись**: документ → primary shard → реплики.
* **Чтение/поиск**: запрос рассылается по шардам → локальный поиск → агрегация результатов.
* Реплики дают **отказоустойчивость** и **распределение нагрузки**.
* Распределение документов по шардам идёт через **хэш от `_id`**.
