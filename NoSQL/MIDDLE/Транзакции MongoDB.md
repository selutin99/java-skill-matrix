# Как работают транзакции в MongoDB и какие они предоставляют гарантии

## 1. Как появились транзакции в MongoDB

* До версии **4.0**:

    * Гарантии были только **atomic operations на уровне документа** (одна запись — всегда атомарна).
    * Для сложных операций приходилось проектировать данные с денормализацией.
* Начиная с **MongoDB 4.0**:

    * Поддерживаются **мульти-документные транзакции** (сначала в пределах реплика-сета).
* С **4.2**:

    * Поддержка транзакций в **шардированных кластерах**.

---

## 2. Как работают транзакции

1. Транзакция открывается с помощью `session.startTransaction()`.
2. Все операции (insert, update, delete, find) выполняются внутри сессии.
3. Данные доступны внутри транзакции только её участникам (snapshot isolation).
4. Завершается транзакция вызовом `commitTransaction()`.
5. Если что-то пошло не так → `abortTransaction()`.

---

## 3. Гарантии транзакций

1. **ACID (на уровне транзакции)**

    * **Atomicity**: все операции внутри транзакции либо применяются, либо откатываются.
    * **Consistency**: транзакция сохраняет целостность данных (если ограничения заданы).
    * **Isolation**: реализована через **snapshot isolation** (читает согласованное состояние на момент старта).
    * **Durability**: при `writeConcern: majority, j:true` изменения гарантированно записаны на диск и реплицированы.

2. **Ограничения**

    * Транзакции «дорогие» по производительности (много служебных операций, блокировок).
    * Лучше использовать **атомарность документа** (одна запись) вместо транзакций там, где возможно.
    * Для шардированных коллекций — особенно внимательны к **shard key** (иначе scatter).

---

## 4. Примеры использования

* Несколько коллекций: нужно одновременно обновить заказ и остатки на складе.
* Обновление связанных документов в разных шардах.
* Критичные бизнес-операции (финансы, биллинг).

---

## 5. Выжимка для собеседования

* До 4.0: транзакции **только на уровне одного документа** (атомарность гарантировалась).
* С 4.0: поддержка **мульти-документных транзакций** в реплика-сетах.
* С 4.2: поддержка в **шардированных кластерах**.
* Гарантии: **полные ACID** (atomicity, consistency, isolation через snapshot, durability при writeConcern majority+journal).
* Минус: транзакции в MongoDB медленнее, чем одиночные операции, поэтому рекомендуют проектировать модель данных с учётом денормализации.
